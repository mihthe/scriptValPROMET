### fig.2B
## chaotic plot > try to plot less patients > plot "sballato" 

# libraries
library(tidyverse)
library(scales)

# differences
difference <- lmed - sim$m_sur
abs_difference <- abs(difference)

# comprehensive data frame
plot_data <- data.frame(
  patient_id = 1:nrow(sim),
  difference = difference,
  abs_difference = abs_difference,
  surface = sim$Su,
  m_sur = sim$m_sur,
  lmed = lmed,
  location = sim$L,
  tumor_size = sim$Si
)

# order by location first, then by tumor size (ascending) within each location
plot_data_ordered <- plot_data %>%
  arrange(location, tumor_size)

# sequential x-position
plot_data_ordered$x_position <- 1:nrow(plot_data_ordered)

# location labels
location_names <- c("Colon-rectum", "Duodenum", "Small intestine", "Stomach", "Esophageal")
plot_data_ordered$location_name <- location_names[plot_data_ordered$location]

# boundaries between locations for visual separation
location_boundaries <- plot_data_ordered %>%
  group_by(location) %>%
  summarise(
    start = min(x_position),
    end = max(x_position),
    mid = (min(x_position) + max(x_position)) / 2,
    n_cases = n(),
    .groups = "drop"
  )

# colors
location_colors <- c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00")
over_col <- "#2ECC71"
under_col <- "#E74C3C"

### FIGURE 1: plot by site and size ###
jpeg(paste0("output/figures/", "Difference_by_Site_and_Size.jpg"), 
     units = "in", 
     width = 18, height = 10, res = 400)

par(mar = c(12, 8, 4, 4))

plot(plot_data_ordered$x_position, plot_data_ordered$difference, 
     type = "n",
     xlab = "", 
     ylab = "Difference (Predicted λ - True Mitotic Count)",
     main = "Prediction Error Ordered by Tumor Site and Size (Ascending)",
     bty = "l",
     ylim = range(plot_data_ordered$difference) * 1.15,
     xaxt = "n",
     cex.lab = 1.5,
     cex.main = 1.7,
     cex.axis = 1.3)

# background shading for each location
for (i in 1:nrow(location_boundaries)) {
  rect(xleft = location_boundaries$start[i] - 0.5,
       xright = location_boundaries$end[i] + 0.5,
       ybottom = par("usr")[3],
       ytop = par("usr")[4],
       col = alpha(location_colors[i], 0.1),
       border = NA)
}

# vertical separators between locations
for (i in 1:(nrow(location_boundaries) - 1)) {
  abline(v = location_boundaries$end[i] + 0.5, 
         col = "gray40", lwd = 2, lty = 2)
}

# horizontal grid
abline(h = seq(floor(min(plot_data_ordered$difference)), 
               ceiling(max(plot_data_ordered$difference)), by = 5),
       col = "gray85", lty = 1)

# vertical lines for each point
segments(x0 = plot_data_ordered$x_position, 
         y0 = 0, 
         y1 = plot_data_ordered$difference,
         col = ifelse(plot_data_ordered$difference > 0, 
                      alpha(over_col, 0.5), 
                      alpha(under_col, 0.5)),
         lwd = 1.5)

# zero line
abline(h = 0, lty = 1, col = "black", lwd = 3)

# points
points(plot_data_ordered$x_position, plot_data_ordered$difference, 
       pch = 21,
       bg = alpha(location_colors[plot_data_ordered$location], 0.8),
       col = "black",
       cex = 1.5,
       lwd = 0.8)

# X-axis: Patient 
axis(1, at = plot_data_ordered$x_position, 
     labels = plot_data_ordered$patient_id,
     las = 2,
     cex.axis = 0.5,
     line = 0)
mtext("Patients", side = 1, line = 3, cex = 1.2)

# X-axis: Tumor sizes
axis(1, at = plot_data_ordered$x_position, 
     labels = round(plot_data_ordered$tumor_size, 1),
     las = 2,
     cex.axis = 0.5,
     col.axis = "darkgreen",
     col.ticks = "darkgreen",
     line = 4.5)
mtext("Tumor Size (standardized)", side = 1, line = 6.5, cex = 1.2, col = "darkgreen")

# X-axis: Location labels (at midpoint of each group)
axis(1, at = location_boundaries$mid, 
     labels = location_names,
     tick = FALSE,
     las = 1,
     cex.axis = 1.1,
     col.axis = "black",
     font = 2,
     line = 8.5)
mtext("Tumor Location", side = 1, line = 9.5, cex = 1.2, font = 2)

# sample size for each location
for (i in 1:nrow(location_boundaries)) {
  text(x = location_boundaries$mid[i],
       y = par("usr")[4] * 0.95,
       labels = paste0("n=", location_boundaries$n_cases[i]),
       cex = 1,
       font = 2)
}

# legend
legend("topleft", 
       title = expression(bold("Prediction Direction")),
       legend = c("Overestimation (λ > y)", 
                  "Underestimation (λ < y)", 
                  "Perfect prediction"),
       col = c(over_col, under_col, "black"),
       lwd = 3, cex = 1.2, bty = "n", inset = c(0, 0.7)) ## STILL OVERLAPPING

dev.off()
